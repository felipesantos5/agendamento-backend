version: "3.8"

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - MONGODB_URI=${MONGODB_URI}
    depends_on:
      - mongodb
      - evolution_api
    restart: unless-stopped

  mongodb:
    image: mongo:6.0
    container_name: barbershop-mongodb
    restart: unless-stopped
    volumes:
      - mongodb_data:/data/db
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}

  evolution_api:
    image: atendai/evolution-api # Imagem oficial da Evolution API
    container_name: barbershop-evolution-api
    restart: unless-stopped
    volumes:
      # Volume persistente para os dados da instância (sessão, QR Code, etc.)
      - evolution_store:/evolution/store
      - evolution_instances:/evolution/instances
    ports:
      # Expõe a porta da API da Evolution para você acessar e configurar
      - "8088:8080"
    environment:
      - "API_KEY=${EVOLUTION_API_KEY}"
      - "DATABASE_ENABLED=true"
      - "DATABASE_CLIENT=mongodb"
      - "DATABASE_CONNECTION_URI=mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongodb:27017/?authSource=admin"
    depends_on:
      - mongodb

volumes:
  mongodb_data:
  evolution_data:
